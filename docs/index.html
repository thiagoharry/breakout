<!doctype html>
<html lang=en-us>
  <head>
    <meta charset=utf-8>
    <meta property="og:image" content="https://thiagoharry.github.io/weaver-interface-metafont/breakout.png">
    <title>Breakout</title>
<style>
    .editor-container {
      position: relative;
      width: 60em;
      height: 600px;
      font-family: monospace;
    }

    .highlighting, textarea {
      position: absolute;
      top: 0;
      left: 0;
      margin: 0;
      padding: 10px;
      width: 100%;
      height: 100%;
      font-size: 14px;
      line-height: 1.5;
      border: 1px solid #ccc;
      border-radius: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: auto;
      box-sizing: border-box;
    }

    .highlighting {
      color: transparent;
      background-color: white;
      pointer-events: none;
      z-index: 1;
    }

    textarea {
      background: transparent;
      color: black;
      z-index: 2;
      resize: none;
    }
    .highlighting{
	font-weight: bold;
    }

    .highlighting .type {
      color: #0066cc;
      font-weight: bold;
    }

    .highlighting .keyword {
      color: #800080;
      font-weight: bold;
    }
    .highlighting .comment .type,
    .highlighting .comment .keyword,
    .highlighting .comment {
	color: #006400; /* verde escuro */
	font-weight: bold;
}

.highlighting .string {
    color: #D2691E; /* chocolate / laranja escuro */
    font-weight: bold;
}
  </style>
  </head>
  <body>
    <div class=spinner id=spinner></div>
    <div class=emscripten id=status>Downloading...</div>
    <div class=emscripten>
      <progress hidden id=progress max=100 value=0></progress>
    </div>
    <div class=emscripten_border>
      <canvas class=emscripten id=canvas oncontextmenu=event.preventDefault() tabindex=-1></canvas>
    </div>
    <script>var statusElement=document.getElementById("status"),progressElement=document.getElementById("progress"),spinnerElement=document.getElementById("spinner"),canvasElement=document.getElementById("canvas"),outputElement=document.getElementById("output");outputElement&&(outputElement.value=""),canvasElement.addEventListener("webglcontextlost",(e=>{alert("WebGL context lost. You will need to reload the page."),e.preventDefault()}),!1);var Module={print(...e){if(console.log(...e),outputElement){var t=e.join(" ");outputElement.value+=t+"\n",outputElement.scrollTop=outputElement.scrollHeight}},canvas:canvasElement,setStatus(e){if(Module.setStatus.last??={time:Date.now(),text:""},e!==Module.setStatus.last.text){var t=e.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/),n=Date.now();t&&n-Module.setStatus.last.time<30||(Module.setStatus.last.time=n,Module.setStatus.last.text=e,t?(e=t[1],progressElement.value=100*parseInt(t[2]),progressElement.max=100*parseInt(t[4]),progressElement.hidden=!1,spinnerElement.hidden=!1):(progressElement.value=null,progressElement.max=null,progressElement.hidden=!0,e||(spinnerElement.style.display="none")),statusElement.innerHTML=e)}},totalDependencies:0,monitorRunDependencies(e){this.totalDependencies=Math.max(this.totalDependencies,e),Module.setStatus(e?"Preparing... ("+(this.totalDependencies-e)+"/"+this.totalDependencies+")":"All downloads complete.")}};Module.setStatus("Downloading..."),window.onerror=e=>{Module.setStatus("Exception thrown, see JavaScript console"),spinnerElement.style.display="none",Module.setStatus=e=>{e&&console.error("[post-exception status] "+e)}}</script><script async src=index.js></script>
    <button onclick="get_code();" style="position:absolute;right:0;top:0vh;z-index:1;">Show Source</button>
    <div id="code_area" style="position:absolute;right:0;top:0vh;display:none;z-index:2;">
      <div class="editor-container">
	<div class="highlighting" id="highlighting" style="background-color:lightgray"></div>
	<textarea id="editor" spellcheck="false" cols="80"></textarea>
      </div>
      <button onclick='run_code()'>Run code!</button><button onclick='close_code()'>Hide Code Editor</button>
    </div>
    <script>
  const textarea = document.getElementById("editor");
  const highlighting = document.getElementById("highlighting");
  const audioCtx = new AudioContext();
      
  const types = ["numeric", "pair", "transform", "path", "picture", "pen", "boolean"];
  const keywords = [
    "scaled", "shifted", "slanted", "xscaled", "yscaled", "zscaled", "trasnformed", "xpart",
    "ypart", "angle", "xxpart", "yypart", "xypart", "yxpart", "cycle", "tension",
    "atleast", "controls", "curl", "reverse", "subpath", "point", "postcontrol",
    "precontrol", "nullpen", "pencircle", "pensemicircle", "makepen", "nullpicture",
    "subpicture", "totalweight", "width", "height", "or", "true", "false", "odd", "not",
    "elseif", "else", "if", "step", "until", "pickup", "bot", "top", "rt", "lft",
    "pickcolor", "monowidth", "draw", "erase", "shipit", "renderchar", "between",
      "kerning", "debug", "begingroup", "endgroup", "fi", "beginchar", "endchar",
      "and", "of"
  ];

  function escapeHTML(str) {
    return str.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;');
  }

  function highlightSyntax(text) {
    // Escape antes de processar
    let escaped = escapeHTML(text);

    // Primeiro, destaque as strings entre aspas duplas
    escaped = escaped.replace(/"([^"\n]*)"/g, (match) => {
      return `<span class="string">${match}</span>`;
    });

    // Em seguida, destaque os comentários (tudo após % até o fim da linha)
    escaped = escaped.replace(/%.*/g, (match) => {
      return `<span class="comment">${match}</span>`;
    });

    // Agora destaque palavras, mas ignorando as que já estão em span (grosso modo)
    escaped = escaped.replace(/\b\w+\b/g, (word) => {
      if (types.includes(word)) {
        return `<span class="type">${word}</span>`;
      } else if (keywords.includes(word)) {
        return `<span class="keyword">${word}</span>`;
      }
      return word;
    });
    return escaped;
  }

      function syncHighlighting() {
	  if (typeof screen.orientation !== 'undefined') {
	      const text = textarea.value;
	      highlighting.innerHTML = highlightSyntax(text) + "\n";
	  }
  }

  textarea.addEventListener("input", syncHighlighting);
  textarea.addEventListener("scroll", () => {
    highlighting.scrollTop = textarea.scrollTop;
    highlighting.scrollLeft = textarea.scrollLeft;
  });

    Module['doNotCaptureKeyboard'] = true;
      syncHighlighting();

      function get_code(){
	  get_source = Module.cwrap('get_source', 'string', []);
	  code = get_source();
	  code_area = document.getElementById("code_area");
	  editor_area = document.getElementById("editor");
	  editor_area.value = code;
          code_area.style.display='block';
          syncHighlighting();
      }

      function run_code(c){
	  put_source = Module.cwrap('put_source', null, ['string']);
	  put_source(editor_area.value);
      }

      function close_code(){
	  code_area = document.getElementById("code_area");
	  code_area.style.display='none';
      }
      var move_up = false;
      var move_down = false;
      var intervalId = setInterval(function() {
	  if(move_up){
	      go_up = Module.cwrap('go_up', null, []);
	      go_up();
	  }
	  else if(move_down){
	      go_down = Module.cwrap('go_down', null, []);
	      go_down();
	  }
      }, 1);
      document.addEventListener('keydown', (event) => {
	  audioCtx.resume();
	  switch (event.key) {
	  case "ArrowUp":
	      move_up = true;
	      break;
	  case "ArrowDown":
	      move_down = true;
	      break;
	  }
      });
      document.addEventListener('keyup', (event) => {
	  switch (event.key) {
	  case "ArrowUp":
	      move_up = false;
	      break;
	  case "ArrowDown":
	      move_down = false;
	      break;

	  }
      });
      
</script>
</body></html>
